/*
    Sophisticated YARA Rules for Malware Detection
    Created for AdvancedMalwareScanner
    Date: April 08, 2025
*/

// Global variables and imports
import "pe"
import "hash"

// Rule 1: Detect EICAR Test String (Standard AV Test)
rule EICAR_Test {
    meta:
        description = "Detects EICAR test file used to verify AV functionality"
        author = "xAI"
        threat_level = "test"
        date = "2025-04-08"
    strings:
        $eicar = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"
    condition:
        $eicar
}

// Rule 2: Suspicious Code Obfuscation
rule Obfuscated_Code {
    meta:
        description = "Detects signs of code obfuscation commonly used in malware"
        author = "xAI"
        threat_level = "high"
        date = "2025-04-08"
    strings:
        $base64_decode = "base64.b64decode" ascii
        $eval = "eval(" ascii
        $exec = "exec(" ascii
        $packed = { 55 8B EC 83 EC ?? 53 56 57 } // Common packer prologue
    condition:
        2 of ($base64_decode, $eval, $exec) or $packed
}

// Rule 3: WannaCry Ransomware Indicators
rule WannaCry_Ransomware {
    meta:
        description = "Detects WannaCry ransomware based on known strings and behavior"
        author = "xAI"
        threat_level = "critical"
        date = "2025-04-08"
    strings:
        $wcry = "WANACRY!" ascii
        $task = "tasksche.exe" ascii
        $ext = ".WNCRY" ascii
        $mutex = "MsWinZonesCacheCounterMutexA" ascii
    condition:
        pe.is_pe and 
        (2 of ($wcry, $task, $ext) or $mutex)
}

// Rule 4: Suspicious Network Activity
rule Network_Activity {
    meta:
        description = "Detects potential network-related malicious behavior"
        author = "xAI"
        threat_level = "medium"
        date = "2025-04-08"
    strings:
        $socket = "socket.socket" ascii
        $http = "http://" ascii
        $https = "https://" ascii
        $ftp = "ftp://" ascii
        $connect = "connect(" ascii
    condition:
        3 of ($socket, $http, $https, $ftp, $connect)
}

// Rule 5: High Entropy Packed File (Heuristic)
rule High_Entropy_Packed {
    meta:
        description = "Detects potentially packed or encrypted files based on entropy"
        author = "xAI"
        threat_level = "medium"
        date = "2025-04-08"
    condition:
        for any section in pe.sections : (
            section.characteristics & pe.SECTION_CNT_CODE and
            math.entropy(section.raw_data) > 7.5
        )
}

// Rule 6: Persistence Mechanisms
rule Persistence_Via_Registry {
    meta:
        description = "Detects attempts to achieve persistence via Windows Registry"
        author = "xAI"
        threat_level = "high"
        date = "2025-04-08"
    strings:
        $reg1 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide
        $reg2 = "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide
        $schtasks = "schtasks /create" ascii
    condition:
        any of ($reg1, $reg2, $schtasks)
}

// Rule 7: Crypto-Mining Indicators
rule Crypto_Miner {
    meta:
        description = "Detects potential crypto-mining malware"
        author = "xAI"
        threat_level = "medium"
        date = "2025-04-08"
    strings:
        $pool = "stratum+tcp://" ascii
        $wallet = /[\da-fA-F]{32,44}/ // Typical wallet address pattern
        $miner = "xmrig" ascii
        $cpu = "cpuminer" ascii
    condition:
        2 of ($pool, $wallet, $miner, $cpu)
}

// Rule 8: Generic Backdoor Detection
rule Generic_Backdoor {
    meta:
        description = "Detects common backdoor characteristics"
        author = "xAI"
        threat_level = "high"
        date = "2025-04-08"
    strings:
        $cmd = "cmd.exe /c" ascii
        $powershell = "powershell.exe" ascii
        $reverse = "reverse_shell" ascii
        $bind = "bind_shell" ascii
    condition:
        pe.imports("kernel32.dll", "CreateProcessA") and
        2 of ($cmd, $powershell, $reverse, $bind)
}

// Rule 9: Suspicious PE Characteristics
rule Suspicious_PE {
    meta:
        description = "Detects suspicious PE file characteristics"
        author = "xAI"
        threat_level = "medium"
        date = "2025-04-08"
    condition:
        pe.is_pe and
        (
            pe.number_of_sections > 10 or
            pe.sections[0].name == "" or
            pe.overlay.size > 1000 or
            pe.timestamp == 0
        )
}

// Rule 10: Polymorphic Malware Detection (Heuristic)
rule Polymorphic_Signs {
    meta:
        description = "Detects signs of polymorphic or metamorphic malware"
        author = "xAI"
        threat_level = "high"
        date = "2025-04-08"
    strings:
        $self_mod = { C6 45 ?? ?? } // Self-modifying code pattern
    condition:
        pe.is_pe and
        $self_mod and
        math.entropy(pe.sections[pe.entry_point].raw_data) > 7.0
}